@page "/login"

@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.OpenIdConnect
@using System.Security.Claims
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Navigation

<page>
    <div class="container border p-3">
        <h3>Вход</h3>

        @if (isAuthenticated)
        {
            <div class="row">
                <div class="col-md-12">
                    <p><b>Здравствуйте, @userName!</b></p>
                    <button class="btn btn-primary" @onclick="Logout">Выход</button>
                </div>
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-md-12">
                    <p>Вы можете войти в систему, используя кнопку ниже.</p>
                    <button class="btn btn-primary" @onclick="LoginWithKeycloak">Вход</button>
                </div>
            </div>
        }
    </div>
</page>

@code {
    [Parameter]
    public string? redirect { get; set; }

    private bool isAuthenticated;
    private string userName = "";

    protected override async Task OnInitializedAsync()
    {
        // Check if user is authenticated
        var httpContext = HttpContextAccessor.HttpContext;
        if (httpContext?.User?.Identity?.IsAuthenticated == true)
        {
            isAuthenticated = true;
            // Try to get the name from Identity.Name first, then from claims
            userName = httpContext.User.Identity.Name ?? httpContext.User.FindFirst(ClaimTypes.Name)?.Value ?? httpContext.User.FindFirst("name")?.Value ?? "Unknown";
        }
    }

    private async Task LoginWithKeycloak()
    {
        if (redirect == "/") redirect = null;
        var redirectUrl = string.IsNullOrEmpty(redirect) ? "/" : $"/{redirect}";
        Navigation.NavigateTo($"/Auth/login?redirectUri={Uri.EscapeDataString(redirectUrl)}", true);
    }

    private async Task Logout()
    {
        Navigation.NavigateTo("/Auth/logout", true);
    }
}
