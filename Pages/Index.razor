@page "/{art?}/{ver?}"

@using Microsoft.AspNetCore.Components.Authorization
@using dwg2img.Data
@using System.Security.Claims
@inject NavigationManager NavigationManager
@inject IHttpContextAccessor HttpContextAccessor

<PageTitle>DWG2IMG</PageTitle>

<AuthorizeView Context="Account">
    <NotAuthorized>
        <Login redirect="@($"{art}/{ver}")"/>
    </NotAuthorized>
    <Authorized>
        <AuthorizeView Policy="SearchQR">
            <NotAuthorized Context="access">
                <p>
                    <h3>@username, доступ запрещен</h3>
                </p>
            </NotAuthorized>
            <Authorized>

                @if (art is null)
                {
                    <div class="alert alert-danger" role="alert">
                        Не указан артикул!
                    </div>
                }
                else
                {
                    <ImageViewer art="@art" ver="@ver" />
                }
            </Authorized>
        </AuthorizeView>
        <p><a href="/" @onclick="Logout" class="fs-6 text-muted"><small>Выйти</small></a></p>
    </Authorized>
</AuthorizeView>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationState { get; set; }

    [Parameter]
    public string? art { get; set; } = "0";
    [Parameter]
    public string? ver { get; set; } = "0";

    private string username = "";

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationState != null)
        {
            var authState = await AuthenticationState;
            var user = authState?.User;
            if (user?.Identity?.IsAuthenticated == true)
            {
                // Try to get the name from Identity.Name first, then from claims
                username = user.Identity?.Name ?? user.FindFirst(ClaimTypes.Name)?.Value ?? user.FindFirst("preferred_username")?.Value ?? "Unknown";
            }
        }
    }

    private async Task Logout()
    {
        NavigationManager.NavigateTo("/Auth/logout", true);
    }
}
